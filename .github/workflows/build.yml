---
name: Build container image
on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - "**/README.md"
      - "packages/**"
      - "Justfile"
  schedule:
    - cron: "05 10 * * *" # 10:05am UTC everyday.
  push:
    branches:
      - main
    paths-ignore:
      - "**/README.md"
      - "packages/**"
      - "Justfile"
  workflow_dispatch:

env:
  IMAGE_DESC: "Custom Fedora Atomic desktop"
  IMAGE_KEYWORDS: "bootc,fedora,hyprland,atomic"
  DEFAULT_TAG: "latest"
  VERSION: 43

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build_push:
    name: Build and push image
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      packages: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        variant: ["hyprland"]

    steps:
      - name: Prepare environment
        run: |
          echo "IMAGE_REGISTRY=ghcr.io/${GITHUB_REPOSITORY_OWNER,,}" >> ${GITHUB_ENV}
          REPO_NAME="${{ github.event.repository.name }}"
          echo "IMAGE_NAME=${REPO_NAME,,}-${{ matrix.variant }}" >> ${GITHUB_ENV}

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      # - name: Maximize build space
      # uses: ublue-os/remove-unwanted-software@695eb75bc387dbcd9685a8e72d23439d8686cba6

      - name: Setup BTRFS container storage
        id: container-storage
        continue-on-error: true
        run: |
          sudo apt-get update && sudo apt-get install -y btrfs-progs

          # Create loopback file using 80% of available space on /mnt
          LOOP_FILE="/mnt/container-storage.img"
          AVAILABLE_KB=$(df --output=avail /mnt | tail -1)
          LOOP_SIZE_KB=$((AVAILABLE_KB * 80 / 100))

          sudo truncate -s "${LOOP_SIZE_KB}K" "${LOOP_FILE}"
          LOOP_DEV=$(sudo losetup --find --show "${LOOP_FILE}")

          sudo mkfs.btrfs -f "${LOOP_DEV}"
          sudo mkdir -p /var/lib/containers
          sudo mount -o compress-force=zstd:2 "${LOOP_DEV}" /var/lib/containers

          echo "Mounted BTRFS storage at /var/lib/containers (${LOOP_SIZE_KB}KB)"

      - name: Generate image metadata
        id: metadata
        run: |
          DATE=$(date -u +%Y%m%d)
          CREATED=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Generate tags (space-separated for buildah)
          TAGS="${{ env.DEFAULT_TAG }} ${{ env.VERSION }}.${DATE} ${DATE} ${{ env.VERSION }}"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            TAGS="${TAGS} sha-${GITHUB_SHA::7} pr-${{ github.event.pull_request.number }}"
          fi
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT

          # Generate labels (newline-separated for rechunk)
          cat <<EOF >> $GITHUB_OUTPUT
          labels<<LABELS_EOF
          org.opencontainers.image.created=${CREATED}
          org.opencontainers.image.description=${{ env.IMAGE_DESC }}
          org.opencontainers.image.documentation=https://raw.githubusercontent.com/${{ github.repository }}/${{ github.sha }}/README.md
          org.opencontainers.image.source=https://github.com/${{ github.repository }}/blob/${{ github.sha }}/Containerfile
          org.opencontainers.image.title=${{ env.IMAGE_NAME }}
          org.opencontainers.image.url=https://github.com/${{ github.repository }}/tree/${{ github.sha }}
          org.opencontainers.image.vendor=${{ github.repository_owner }}
          org.opencontainers.image.version=${{ env.VERSION }}.${DATE}
          containers.bootc=1
          LABELS_EOF
          EOF

      - name: Build Image
        id: build_image
        run: |
          sudo buildah build \
            --build-arg=VARIANT="${{ matrix.variant }}" \
            --storage-driver=overlay \
            --format=docker \
            --file ./Containerfile \
            --tag ${IMAGE_NAME}:${DEFAULT_TAG} \
            .

      - name: Run Rechunker
        id: rechunk
        uses: hhd-dev/rechunk@v1.2.4
        with:
          rechunk: "ghcr.io/hhd-dev/rechunk:v1.2.4"
          ref: "${{ env.IMAGE_NAME }}:${{ env.DEFAULT_TAG }}" # Do not edit ref and prev-ref. Currently: compare between local 'latest' and registry's 'latest'.
          prev-ref: "${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.DEFAULT_TAG }}"
          version: "${{ env.VERSION }}.${{ steps.metadata.outputs.date }}" # Same as in metadata step.
          labels: ${{ steps.metadata.outputs.labels }}

      # This is necessary so that the podman socket can find the rechunked image on its storage:
      - name: Load in podman and tag
        run: |
          IMAGE=$(sudo podman pull ${{ steps.rechunk.outputs.ref }})
          sudo rm -rf ${{ steps.rechunk.outputs.output }}
          for tag in ${{ steps.metadata.outputs.tags }}; do
            sudo podman tag $IMAGE ${{ env.IMAGE_NAME }}:$tag
          done

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | sudo skopeo login --username ${{ github.actor }} --password-stdin ghcr.io

      - name: Push To GHCR
        if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        id: push
        run: |
          IMAGE_REF="${{ steps.rechunk.outputs.ref }}"

          DIGEST=$(sudo skopeo inspect --format '{{.Digest}}' "$IMAGE_REF")
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

          for tag in ${{ steps.metadata.outputs.tags }}; do
            dest_image="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:$tag"
            sudo skopeo copy "$IMAGE_REF" docker://"$dest_image"
            echo "Pushed $dest_image"
          done

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)

      - name: Sign container image
        if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        run: |
          IMAGE_FULL="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}"
          for tag in ${{ steps.metadata.outputs.tags }}; do
            cosign sign -y --key env://COSIGN_PRIVATE_KEY $IMAGE_FULL:$tag
          done
        env:
          TAGS: ${{ steps.push.outputs.digest }} # The digest of the push.
          COSIGN_EXPERIMENTAL: false
          COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
          COSIGN_REGISTRY_USERNAME: ${{ github.actor }}
          COSIGN_REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
